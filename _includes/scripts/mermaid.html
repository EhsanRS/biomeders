<!-- Mermaid.js -->
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

  // Convert code blocks with language-mermaid to mermaid divs
  document.querySelectorAll('code.language-mermaid').forEach((codeBlock) => {
    const pre = codeBlock.parentElement;
    const div = document.createElement('div');
    div.className = 'mermaid';
    div.textContent = codeBlock.textContent;
    pre.parentNode.replaceChild(div, pre);
  });

  // Get current theme
  const theme = document.documentElement.getAttribute('data-theme');
  const mermaidTheme = theme === 'dark' ? 'dark' : 'default';

  mermaid.initialize({
    startOnLoad: true,
    theme: mermaidTheme,
    securityLevel: 'loose',
    fontFamily: 'Inter, system-ui, sans-serif'
  });

  // Re-render on theme change
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'data-theme') {
        const newTheme = document.documentElement.getAttribute('data-theme');
        const newMermaidTheme = newTheme === 'dark' ? 'dark' : 'default';

        // Re-render all mermaid diagrams
        document.querySelectorAll('.mermaid').forEach((el) => {
          const code = el.getAttribute('data-original') || el.textContent;
          el.setAttribute('data-original', code);
          el.removeAttribute('data-processed');
          el.textContent = code;
        });

        mermaid.initialize({
          startOnLoad: false,
          theme: newMermaidTheme,
          securityLevel: 'loose',
          fontFamily: 'Inter, system-ui, sans-serif'
        });
        mermaid.run();
      }
    });
  });

  observer.observe(document.documentElement, { attributes: true });
</script>
